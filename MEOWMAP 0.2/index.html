<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MeowAfisha — карта событий</title>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #topbar { padding: 8px 12px; background:#fafafa; border-bottom:1px solid #eee; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    #map { width:100%; height: calc(100% - 52px); }
    .pill { padding: 4px 8px; background:#f0f0f0; border-radius:999px; font-size: 12px; }
    .popup { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size:14px; }
    .popup b { font-size:15px; display:block; margin-bottom:4px; }
    .popup img { max-width: 220px; border-radius:8px; display:block; margin-top:6px; }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@10.6.0/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@10.6.0/ol.js"></script>
</head>
<body>
  <div id="topbar">
    <label for="event-date">Дата:</label>
    <input type="date" id="event-date">
    <span id="count" class="pill">0</span>
  </div>
  <div id="map"></div>

<script>
const JSON_URL = "events.json";
const tzOffset = "+02:00";

const map = new ol.Map({
  target: "map",
  layers: [ new ol.layer.Tile({ source: new ol.source.OSM() }) ],
  view: new ol.View({ center: ol.proj.fromLonLat([20.45, 54.71]), zoom: 11 })
});
let vectorLayer = null;

function clearLayer(){
  if (vectorLayer) map.removeLayer(vectorLayer);
  vectorLayer = null;
}
function featureForEvent(ev){
  const feat = new ol.Feature({
    geometry: new ol.geom.Point(ol.proj.fromLonLat([ev.lon, ev.lat])),
    name: ev.title
  });
  feat.setStyle(new ol.style.Style({
    image: new ol.style.Circle({ radius: 6, fill: new ol.style.Fill({ color: "#ff5722" }) })
  }));
  feat.set("popup", popupHTML(ev));
  return feat;
}

function popupHTML(ev){
  const dt = new Date(ev.start);
  const dateStr = dt.toLocaleString('ru-RU', { dateStyle:'medium', timeStyle: ev.time_unknown ? undefined : 'short' });
  const timePart = ev.time_unknown ? "Время не указано" : dt.toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' });
  const img = (ev.images && ev.images[0]) ? `<img src="${ev.images[0]}" alt="">` : "";
  const src = ev.source_url ? `<div><a href="${ev.source_url}" target="_blank" rel="noopener">Источник</a></div>` : "";
  const addr = ev.address ? `<div>${ev.address}</div>` : "";
  return `<div class="popup"><b>${escapeHtml(ev.title)}</b><div>${dateStr} · ${timePart}</div>${addr}${src}${img}</div>`;
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",""":"&quot;","'":"&#39;"}[c]));
}

function renderEvents(list){
  clearLayer();
  const feats = list.map(featureForEvent);
  const src = new ol.source.Vector({ features: feats });
  vectorLayer = new ol.layer.Vector({ source: src });
  map.addLayer(vectorLayer);
}

function filterByDate(all, ymd){
  return all.filter(ev => ev.start.slice(0,10) === ymd);
}

let EVENTS = [];
fetch(JSON_URL).then(r => r.json()).then(data => {
  EVENTS = data;
  const dates = EVENTS.map(e => e.start.slice(0,10)).sort();
  const minD = dates[0], maxD = dates[dates.length-1];
  const input = document.getElementById('event-date');
  input.min = minD; input.max = maxD;
  const today = new Date().toISOString().slice(0,10);
  const def = (today >= minD && today <= maxD) ? today : minD;
  input.value = def;
  const todays = filterByDate(EVENTS, def);
  renderEvents(todays);
  document.getElementById('count').textContent = String(todays.length);
  input.addEventListener('change', e => {
    const ymd = e.target.value;
    const list = filterByDate(EVENTS, ymd);
    renderEvents(list);
    document.getElementById('count').textContent = String(list.length);
  });
});
</script>
</body>
</html>
