<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>MeowAfisha ‚Äî –∫–∞—Ä—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body { margin:0; font-family:sans-serif; }
    #controls { padding:12px; background:#f7f7f7; }
    input[type=date] { font-size:16px; }
    #sidebar {
      width:300px;
      background:#fff;
      padding:12px;
      overflow-y:auto;
      font-size:14px;
      border-left:1px solid #ccc;
    }
    #map { flex:1; }
    .maplibregl-popup-content { font-size:14px; line-height:1.3; }
  </style>
</head>
<body>
  <div id="controls">
    <label for="event-date">üìÖ –î–∞—Ç–∞: </label>
    <input type="date" id="event-date">
    <span id="count"></span>
  </div>

  <div style="display:flex; flex-direction:row; height:90vh;">
    <div id="map"></div>
    <div id="sidebar">
      <h3>–ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
      <div id="upcoming"></div>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    const JSON_URL = 'events.json?v=20250727';
    const MAPTILER_KEY = 'QAuK0LSzMpyDV8I7iX6a';

    const map = new maplibregl.Map({
      container: 'map',
      style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`,
      center: [20.45, 54.71],
      zoom: 10
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-right');
    let markers = [];

    function clearMarkers() {
      markers.forEach(m => m.remove());
      markers = [];
    }

    function addEventMarker(ev) {
      const popup = new maplibregl.Popup({ offset: 25 })
        .setHTML(`<b>${ev.title}</b><br>${ev.location}<br>${ev.date}`);

      const marker = new maplibregl.Marker()
        .setLngLat([ev.lon, ev.lat])
        .setPopup(popup)
        .addTo(map);

      markers.push(marker);
    }

    fetch(JSON_URL)
      .then(r => r.json())
      .then(events => {
        events.sort((a, b) => a.date.localeCompare(b.date));
        const minDate = events[0].date;
        const maxDate = events[events.length - 1].date;
        const input = document.getElementById('event-date');
        input.min = minDate;
        input.max = maxDate;
        const today = new Date().toISOString().slice(0, 10);
        const first = events.find(e => e.date >= today) ? today : minDate;
        input.value = first;

        // –ë–ª–∏–∂–∞–π—à–∏–µ 3 —Å–æ–±—ã—Ç–∏—è
        const todayObj = new Date();
        const upcoming = events
          .filter(e => new Date(e.date) >= todayObj)
          .slice(0, 3);

        const upcomingDiv = document.getElementById('upcoming');
        if (upcoming.length === 0) {
          upcomingDiv.innerHTML = '<p>–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π</p>';
        } else {
          upcoming.forEach(e => {
            const el = document.createElement('div');
            el.style.marginBottom = '1em';
            el.innerHTML = `<strong>${e.title}</strong><br>${e.location}<br><i>${e.date}</i>`;
            upcomingDiv.appendChild(el);
          });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –ø–æ –¥–∞—Ç–µ
        function updateMap(dateStr) {
          clearMarkers();
          const todays = events.filter(e => e.date === dateStr);
          todays.forEach(addEventMarker);
          document.getElementById('count').textContent = `‚Äì –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π: ${todays.length}`;
          if (todays.length) {
            map.flyTo({ center: [todays[0].lon, todays[0].lat], zoom: 12 });
          }
        }

        updateMap(first);
        input.addEventListener('change', e => {
          const selected = new Date(e.target.value).toISOString().slice(0, 10);
          updateMap(selected);
        });
      })
      .catch(err => console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å events.json', err));
  </script>
</body>
</html>
