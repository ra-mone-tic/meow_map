<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>MeowAfisha ‚Äî –∫–∞—Ä—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet"/>
  <style>
    :root { --panel-w: 320px; }

    body{margin:0;font-family:sans-serif;}
    #controls{
      display:flex;align-items:center;gap:8px;
      padding:12px;background:#f7f7f7;border-bottom:1px solid #ccc;
    }
    input[type=date]{font-size:16px;}
    #logo{height:32px;}
    #burger{cursor:pointer;font-size:26px;margin-left:auto;display:block;} /* –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±—É—Ä–≥–µ—Ä */
    #map{flex:1;}

    /* –°–∞–π–¥–±–∞—Ä ‚Äî —Ç–µ–ø–µ—Ä—å –æ–≤–µ—Ä–ª–µ–π –¥–ª—è –≤—Å–µ—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ —ç–∫—Ä–∞–Ω–∞ */
    #sidebar{
      position:fixed;right:0;top:0;height:100vh;width:var(--panel-w);
      background:#fff;overflow-y:auto;
      padding:12px;font-size:14px;
      box-shadow:-4px 0 6px rgba(0,0,0,.15);
      transform:translateX(100%);          /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–∫—Ä—ã—Ç */
      transition:transform .3s ease;
      z-index:999;
      border-left:1px solid #ccc;
    }
    #sidebar.open{ transform:translateX(0); }

    #sidebar div.item{
      margin-bottom:12px;cursor:pointer;
      border-bottom:1px dashed #ccc;padding-bottom:8px;
    }
    #sidebar div.item:hover{background:#f0f0f0;}
    #closeSidebar{cursor:pointer;font-size:22px;font-weight:bold;}

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã –≤–æ –≤—Å—é –≤—ã—Å–æ—Ç—É –æ–∫–Ω–∞ (–º–∏–Ω—É—Å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è) */
    #layout{display:flex;height:calc(100vh - 58px);}
  </style>
</head>
<body>

  <div id="controls">
    <label for="event-date">üìÖ</label>
    <input type="date" id="event-date">
    <img id="logo"
         src="https://sun9-81.userapi.com/impf/rcuLPGnzIPly7IQhX6MbA5TICbdWnl6AhMVSXQ/dFRCwb6vi5k.jpg?size=1818x606&quality=95&crop=0,21,1541,513&sign=34cbe06fb366638d9c7ca0693f1f83ef&type=cover_group"
         alt="Meow Records">
    <span id="burger">‚ò∞</span>
  </div>

  <div id="layout">
    <div id="map"></div>

    <div id="sidebar" aria-hidden="true">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3 style="margin:0;">–ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
        <span id="closeSidebar" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</span>
      </div>
      <hr>
      <div id="upcoming"></div>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    const JSON_URL     = 'events.json?v=20250730';
    const MAPTILER_KEY = 'QAuK0LSzMpyDV8I7iX6a';

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø UI ‚Äî —Å—Ä–∞–∑—É, –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö ===
    const sidebarEl = document.getElementById('sidebar');
    const burgerEl  = document.getElementById('burger');
    const closeEl   = document.getElementById('closeSidebar');

    function openSidebar(){ sidebarEl.classList.add('open');  sidebarEl.setAttribute('aria-hidden','false'); }
    function closeSidebar(){ sidebarEl.classList.remove('open'); sidebarEl.setAttribute('aria-hidden','true'); }
    function toggleSidebar(){ sidebarEl.classList.toggle('open'); sidebarEl.setAttribute('aria-hidden', sidebarEl.classList.contains('open') ? 'false' : 'true'); }

    burgerEl.onclick = toggleSidebar;
    closeEl.onclick  = closeSidebar;

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSidebar(); });

    // === –ö–ê–†–¢–ê ===
    const map = new maplibregl.Map({
      container:'map',
      style:`https://api.maptiler.com/maps/basic/style.json?key=${MAPTILER_KEY}`,
      center:[20.45,54.71],
      zoom:10
    });

    map.addControl(new maplibregl.NavigationControl(),'top-right');
    map.addControl(new maplibregl.GeolocateControl({
      positionOptions:{enableHighAccuracy:true},
      showUserLocation:true
    }),'top-right');

    // –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞—Ä—Ç—ã
    map.on('load', () => { setTimeout(() => map.resize(), 100); });

    // === –î–ê–ù–ù–´–ï ===
    let markers=[];

    function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }
    function addMarker(ev){
      const pop=new maplibregl.Popup({offset:25})
        .setHTML(`<b>${ev.title}</b><br>${ev.location}<br>${ev.date}`);
      const m=new maplibregl.Marker().setLngLat([ev.lon,ev.lat]).setPopup(pop).addTo(map);
      markers.push(m);
    }

    async function loadEvents(){
      try{
        const r = await fetch(JSON_URL, { cache:'no-store' });
        if(!r.ok) return [];
        const data = await r.json();
        return Array.isArray(data) ? data : [];
      }catch(err){
        console.warn('events.json load failed:', err);
        return [];
      }
    }

    function renderForDate(events, dateStr){
      clearMarkers();
      const todays = events.filter(e => e.date === dateStr);
      todays.forEach(addMarker);
      if(todays.length){
        map.flyTo({center:[todays[0].lon,todays[0].lat],zoom:12});
      }
    }

    (async function bootstrap(){
      const events = await loadEvents();

      if(!events.length){
        document.getElementById('upcoming').textContent = '–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
        return; // UI –æ—Å—Ç–∞—ë—Ç—Å—è —Ä–∞–±–æ—á–∏–º (–±—É—Ä–≥–µ—Ä/–∑–∞–∫—Ä—ã—Ç–∏–µ)
      }

      events.sort((a,b)=>a.date.localeCompare(b.date));

      const input  = document.getElementById('event-date');
      input.min    = events[0].date;
      input.max    = events.at(-1).date;

      const today = new Date().toISOString().slice(0,10);

      // –æ–≥—Ä–∞–Ω–∏—á–∏–º today –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
      if (today < input.min) {
        input.value = input.min;
      } else if (today > input.max) {
        input.value = input.max;
      } else {
        input.value = today;
      }


      const upDiv = document.getElementById('upcoming');
      const upcoming = events.filter(e => e.date >= today).slice(0,100);
      if(!upcoming.length){
        upDiv.textContent='—Å–æ–±—ã—Ç–∏–π –Ω–µ—Ç';
      } else {
        upcoming.forEach(e=>{
          const d=document.createElement('div');
          d.className='item';
          d.innerHTML=`<strong>${e.title}</strong><br>${e.location}<br><i>${e.date}</i>`;
          d.onclick=()=>{
            renderForDate(events, e.date);
            setTimeout(()=>{
              const m = markers.find(mk => {
                const p = mk.getLngLat();
                return Math.abs(p.lat - e.lat) < 1e-5 && Math.abs(p.lng - e.lon) < 1e-5;
              });
              if (m) {
                map.flyTo({center:[e.lon,e.lat],zoom:14});
                m.togglePopup();
              }
              closeSidebar();
            },100);
          };
          upDiv.appendChild(d);
        });
      }

      renderForDate(events, firstExisting);
      input.onchange = ev => {
        const d=new Date(ev.target.value).toISOString().slice(0,10);
        renderForDate(events, d);
      };
    })();
  </script>
</body>
</html>
