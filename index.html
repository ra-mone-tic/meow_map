<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>MeowAfisha ‚Äî –∫–∞—Ä—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body { margin:0; font-family:sans-serif; }
    #controls{
      display:flex; align-items:center; gap:8px;
      padding:12px; background:#f7f7f7; border-bottom:1px solid #ccc;
    }
    #map       { flex:1; }
    #sidebar   {
      width:300px; background:#fff; overflow-y:auto;
      padding:12px; font-size:14px; border-left:1px solid #ccc;
    }
    #sidebar div.item{ margin-bottom:12px; cursor:pointer; border-bottom:1px dashed #ccc; padding-bottom:8px; }
    #sidebar div.item:hover{ background:#f0f0f0; }
    input[type=date]{ font-size:16px; }
    .maplibregl-popup-content{ font-size:14px; line-height:1.3; }
    #count{ margin-left:auto; font-weight:bold; }
  </style>
</head>

<body>
  <!-- –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div id="controls">
    <label for="event-date">üìÖ –î–∞—Ç–∞:</label>
    <input type="date" id="event-date">
    <img id="logo" src="https://sun9-81.userapi.com/impf/rcuLPGnzIPly7IQhX6MbA5TICbdWnl6AhMVSXQ/dFRCwb6vi5k.jpg?size=1818x606&quality=95&crop=0,21,1541,513&sign=34cbe06fb366638d9c7ca0693f1f83ef&type=cover_group"
         alt="Meow Records" style="height:32px;">
    <span id="count"></span>
  </div>

  <!-- –∫–∞—Ä—Ç–∞ + —Å–∞–π–¥–±–∞—Ä -->
  <div style="display:flex; height:90vh;">
    <div id="map"></div>
    <div id="sidebar">
      <h3>–ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
      <div id="upcoming"></div>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    const JSON_URL    = 'events.json?v=20250728';          // –æ–±–Ω–æ–≤–ª—è–π v= –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ
    const MAPTILER_KEY = 'QAuK0LSzMpyDV8I7iX6a';

    /* –∫–∞—Ä—Ç–∞ */
    const map = new maplibregl.Map({
      container: 'map',
      style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`,
      center: [20.45, 54.71],
      zoom: 10
    });
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    /* –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –º–∞—Ä–∫–µ—Ä–æ–≤ */
    let markers = [];

    function clearMarkers(){
      markers.forEach(m=>m.remove());
      markers = [];
    }

    function addEventMarker(ev){
      const popup  = new maplibregl.Popup({offset:25})
                       .setHTML(`<b>${ev.title}</b><br>${ev.location}<br>${ev.date}`);
      const marker = new maplibregl.Marker()
                       .setLngLat([ev.lon, ev.lat])
                       .setPopup(popup)
                       .addTo(map);
      marker.__key = `${ev.date}|${ev.title}`;   // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
      markers.push(marker);
    }

    fetch(JSON_URL)
      .then(r=>r.json())
      .then(events=>{
        /* —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
        events.sort((a,b)=>a.date.localeCompare(b.date));
        const input   = document.getElementById('event-date');
        input.min     = events[0].date;
        input.max     = events.at(-1).date;
        const todayISO = new Date().toISOString().slice(0,10);
        const first   = events.find(e=>e.date>=todayISO) ? todayISO : events[0].date;
        input.value   = first;

        /* —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Ä–∏—Å–æ–≤–∫–∏ –∫–∞—Ä—Ç—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–µ */
        function updateMap(dateStr){
          clearMarkers();
          const todays = events.filter(e=>e.date===dateStr);
          todays.forEach(addEventMarker);
          document.getElementById('count').textContent = todays.length;
          if(todays.length){
            map.flyTo({center:[todays[0].lon, todays[0].lat], zoom:12});
          }
        }

        /* –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–∞–π–¥–±–∞—Ä–∞ (–¥–æ 100 –±—É–¥—É—â–∏—Ö) */
        const upcomingDiv = document.getElementById('upcoming');
        const upcoming = events
          .filter(e=>new Date(e.date) >= new Date(todayISO))
          .slice(0,100);

        if(upcoming.length===0){
          upcomingDiv.innerHTML='<p>–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π</p>';
        }else{
          upcoming.forEach(e=>{
            const item = document.createElement('div');
            item.className='item';
            item.innerHTML=`<strong>${e.title}</strong><br>${e.location}<br><i>${e.date}</i>`;
            item.addEventListener('click', ()=>{
              /* —Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã —Ç–æ–π –¥–∞—Ç—ã */
              updateMap(e.date);

              /* –∏—â–µ–º –Ω—É–∂–Ω—ã–π –º–∞—Ä–∫–µ—Ä –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ */
              const m = markers.find(mk=>Math.abs(mk.getLngLat().lat - e.lat)<1e-5 &&
                                         Math.abs(mk.getLngLat().lng - e.lon)<1e-5);
              if(m){
                m.togglePopup();
              }
              map.flyTo({center:[e.lon, e.lat], zoom:14});
            });
            upcomingDiv.appendChild(item);
          });
        }

        /* –ø–µ—Ä–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ */
        updateMap(first);
        input.addEventListener('change', ev=>{
          const sel = new Date(ev.target.value).toISOString().slice(0,10);
          updateMap(sel);
        });
      })
      .catch(err=>console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å events.json', err));
  </script>
</body>
</html>
