<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>MeowAfisha ‚Äî –∫–∞—Ä—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ –∫–∞—Ä—Ç—ã -->
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet"/>

  <style>
    /* ===== –ë–ê–ó–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï/–°–¢–ò–õ–ò ===== */
    :root { --panel-w: 320px; } /* —à–∏—Ä–∏–Ω–∞ –≤—ã–µ–∑–∂–∞—é—â–µ–π –ø–∞–Ω–µ–ª–∏ */

    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    /* ===== –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===== */
    #controls {
      display: flex; align-items: center; gap: 8px;
      padding: 12px; background: #f7f7f7; border-bottom: 1px solid #ccc;
    }
    input[type="date"] { font-size: 16px; }
    #logo { height: 32px; }
    #burger { cursor: pointer; font-size: 26px; margin-left: auto; display: block; } /* –±—É—Ä–≥–µ—Ä –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω */

    /* ===== –û–°–ù–û–í–ù–û–ô –õ–ï–ô–ê–£–¢ (–∫–∞—Ä—Ç–∞ –Ω–∞ –≤—Å—é –≤—ã—Å–æ—Ç—É) ===== */
    #layout { display: flex; height: calc(100vh - 58px); } /* 58px ‚Äî –≤—ã—Å–æ—Ç–∞ controls */
    #map    { flex: 1; }

    /* ===== –í–´–ï–ó–ñ–ê–Æ–©–ò–ô –°–ê–ô–î–ë–ê–† (–æ–≤–µ—Ä–ª–µ–π –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö) ===== */
    #sidebar {
      position: fixed; right: 0; top: 0; height: 100vh; width: var(--panel-w);
      background: #fff; overflow-y: auto; padding: 12px; font-size: 14px;
      box-shadow: -4px 0 6px rgba(0,0,0,.15);
      transform: translateX(100%);  /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
      transition: transform .3s ease;
      z-index: 999; border-left: 1px solid #ccc;
    }
    #sidebar.open { transform: translateX(0); } /* –∫–ª–∞—Å—Å –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ */

    /* ===== –≠–õ–ï–ú–ï–ù–¢–´ –°–ü–ò–°–ö–ê –°–û–ë–´–¢–ò–ô ===== */
    #sidebar .item {
      margin-bottom: 12px; cursor: pointer;
      border-bottom: 1px dashed #ccc; padding-bottom: 8px;
    }
    #sidebar .item:hover { background: #f0f0f0; }
    #closeSidebar { cursor: pointer; font-size: 22px; font-weight: bold; }
  </style>
</head>
<body>

  <!-- ===== –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø: –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –ª–æ–≥–æ—Ç–∏–ø, –±—É—Ä–≥–µ—Ä ===== -->
  <div id="controls">
    <label for="event-date">üìÖ</label>
    <input type="date" id="event-date" />
    <img
      id="logo"
      alt="Meow Records"
      src="https://sun9-81.userapi.com/impf/rcuLPGnzIPly7IQhX6MbA5TICbdWnl6AhMVSXQ/dFRCwb6vi5k.jpg?size=1818x606&quality=95&crop=0,21,1541,513&sign=34cbe06fb366638d9c7ca0693f1f83ef&type=cover_group"
    />
    <span id="burger" title="–°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π">‚ò∞</span>
  </div>

  <!-- ===== –û–°–ù–û–í–ù–û–ô –õ–ï–ô–ê–£–¢: –∫–∞—Ä—Ç–∞ + –≤—ã–µ–∑–∂–∞—é—â–∏–π —Å–∞–π–¥–±–∞—Ä ===== -->
  <div id="layout">
    <div id="map"></div>

    <div id="sidebar" aria-hidden="true">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3 style="margin:0;">–ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
        <span id="closeSidebar" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</span>
      </div>
      <hr />
      <div id="upcoming"></div>
    </div>
  </div>

  <!-- JS –∫–∞—Ä—Ç—ã -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

  <script>
    /* ===== –ö–û–ù–§–ò–ì ===== */
    const JSON_URL     = 'events.json?v=20250730';     // –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö (–≤–∞—Ä–∏–∞–Ω—Ç A)
    const MAPTILER_KEY = 'QAuK0LSzMpyDV8I7iX6a';       // –∫–ª—é—á —Å—Ç–∏–ª—è –∫–∞—Ä—Ç—ã

    /* ===== UI: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö (—á—Ç–æ–±—ã –±—É—Ä–≥–µ—Ä –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–ª) ===== */
    const sidebarEl = document.getElementById('sidebar');
    const burgerEl  = document.getElementById('burger');
    const closeEl   = document.getElementById('closeSidebar');

    function openSidebar(){  sidebarEl.classList.add('open');   sidebarEl.setAttribute('aria-hidden','false'); }
    function closeSidebar(){ sidebarEl.classList.remove('open'); sidebarEl.setAttribute('aria-hidden','true'); }
    function toggleSidebar(){ sidebarEl.classList.toggle('open'); sidebarEl.setAttribute('aria-hidden', sidebarEl.classList.contains('open') ? 'false' : 'true'); }

    burgerEl.addEventListener('click', toggleSidebar);
    closeEl.addEventListener('click', closeSidebar);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSidebar(); });

    /* ===== –ö–ê–†–¢–ê ===== */
    const map = new maplibregl.Map({
      container: 'map',
      style: `https://api.maptiler.com/maps/basic/style.json?key=${MAPTILER_KEY}`,
      center: [20.45, 54.71],
      zoom: 10
    });

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è + –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
    map.addControl(new maplibregl.NavigationControl(), 'top-right');
    map.addControl(new maplibregl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      showUserLocation: true
    }), 'top-right');

    // –ú–∏–∫—Ä–æ-—Ñ–∏–∫—Å: –∏–Ω–æ–≥–¥–∞ —Ç–∞–π–ª—ã –ø—Ä–æ–≥—Ä—É–∂–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    map.on('load', () => { setTimeout(() => map.resize(), 100); });

    /* ===== –†–ï–ù–î–ï–† –°–û–ë–´–¢–ò–ô –ù–ê –ö–ê–†–¢–ï ===== */
    let markers = [];

    function clearMarkers() {
      markers.forEach(m => m.remove());
      markers = [];
    }

    function addMarker(ev) {
      const html = `<b>${ev.title}</b><br>${ev.location}<br>${ev.date}`;
      const pop  = new maplibregl.Popup({ offset: 25 }).setHTML(html);
      const m    = new maplibregl.Marker().setLngLat([ev.lon, ev.lat]).setPopup(pop).addTo(map);
      markers.push(m);
    }

    function renderForDate(events, dateStr) {
      clearMarkers();
      const todays = events.filter(e => e.date === dateStr); // —Å—Ç—Ä–æ–≥–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ "YYYY-MM-DD"
      todays.forEach(addMarker);
      if (todays.length) {
        map.flyTo({ center: [todays[0].lon, todays[0].lat], zoom: 12 });
      }
    }

    /* ===== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ===== */
    async function loadEvents() {
      try {
        const r = await fetch(JSON_URL, { cache: 'no-store' });
        if (!r.ok) return [];
        const data = await r.json();
        return Array.isArray(data) ? data : [];
      } catch (err) {
        console.warn('events.json load failed:', err);
        return [];
      }
    }

    /* ===== –û–°–ù–û–í–ù–û–ô –ü–û–¢–û–ö ===== */
    (async function bootstrap() {
      const events = await loadEvents();

      // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî UI –æ—Å—Ç–∞—ë—Ç—Å—è –∂–∏–≤—ã–º (–±—É—Ä–≥–µ—Ä/–∑–∞–∫—Ä—ã—Ç–∏–µ), –ø–æ–∫–∞–∂–µ–º –∑–∞–≥–ª—É—à–∫—É
      if (!events.length) {
        document.getElementById('upcoming').textContent = '–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
        return;
      }

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
      events.sort((a, b) => a.date.localeCompare(b.date));

      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî –≥—Ä–∞–Ω–∏—Ü—ã min/max –ø–æ –º–∞—Å—Å–∏–≤—É —Å–æ–±—ã—Ç–∏–π
      const input = document.getElementById('event-date');
      input.min   = events[0].date;
      input.max   = events.at(-1).date;

      // –°—Ç–∞–≤–∏–º –¢–ï–ö–£–©–£–Æ –¥–∞—Ç—É (–Ω–æ –Ω–µ –≤—ã—Ö–æ–¥–∏–º –∑–∞ –ø—Ä–µ–¥–µ–ª—ã min/max)
      const today = new Date().toISOString().slice(0, 10);
      if      (today < input.min) input.value = input.min;
      else if (today > input.max) input.value = input.max;
      else                        input.value = today;

      // –ì–æ—Ç–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ –±–ª–∏–∂–∞–π—à–∏—Ö —Å–æ–±—ã—Ç–∏–π (–¥–æ 100)
      const upDiv    = document.getElementById('upcoming');
      const upcoming = events.filter(e => e.date >= today).slice(0, 100);
      if (!upcoming.length) {
        upDiv.textContent = '–°–∫–æ—Ä–æ —Å–æ–±—ã—Ç–∏–π –Ω–µ—Ç';
      } else {
        upcoming.forEach(e => {
          const d = document.createElement('div');
          d.className = 'item';
          d.innerHTML = `<strong>${e.title}</strong><br>${e.location}<br><i>${e.date}</i>`;
          d.onclick   = () => {
            renderForDate(events, e.date);
            setTimeout(() => {
              // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–∞—Ä–∫–µ—Ä –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø
              const m = markers.find(mk => {
                const p = mk.getLngLat();
                return Math.abs(p.lat - e.lat) < 1e-5 && Math.abs(p.lng - e.lon) < 1e-5;
              });
              if (m) {
                map.flyTo({ center: [e.lon, e.lat], zoom: 14 });
                m.togglePopup();
              }
              closeSidebar();
            }, 100);
          };
          upDiv.appendChild(d);
        });
      }

      // –ü–µ—Ä–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ ‚Äî –ø–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –¥–∞—Ç–µ –≤ –∏–Ω–ø—É—Ç–µ (–æ–±—ã—á–Ω–æ today)
      renderForDate(events, input.value);

      // –í–ê–ñ–ù–û: –±–µ—Ä—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–Ω–ø—É—Ç–∞ –∫–∞–∫ –µ—Å—Ç—å, –±–µ–∑ toISOString (–∏–Ω–∞—á–µ UTC-—Å–¥–≤–∏–≥)
      const onDateChange = (ev) => {
        const d = ev.target.value;   // —É–∂–µ "YYYY-MM-DD"
        renderForDate(events, d);
      };
      input.addEventListener('change', onDateChange);
      input.addEventListener('input', onDateChange);
    })();
  </script>
</body>
</html>
